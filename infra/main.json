{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.29.47.4906",
      "templateHash": "8926597517400072511"
    }
  },
  "parameters": {
    "suffix": {
      "type": "string",
      "defaultValue": "[substring(newGuid(), 0, 6)]",
      "minLength": 4,
      "maxLength": 6,
      "metadata": {
        "description": "Suffix to create unique resource names; 4-6 characters. Default is a random 6 characters."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Application": "Kernel-Memory",
        "Environment": "Demo"
      },
      "metadata": {
        "description": "The tags to apply to all resources. Refer to https://learn.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging for best practices."
      }
    },
    "KernelMemoryImageTag": {
      "type": "string",
      "defaultValue": "latest",
      "minLength": 3,
      "maxLength": 16,
      "metadata": {
        "description": "Kernel Memory Docker Image Tag.  Check available tags at https://hub.docker.com/r/kernelmemory/service/tags\n"
      }
    },
    "InferenceModel": {
      "type": "string",
      "defaultValue": "gpt-35-turbo-16k",
      "allowedValues": [
        "gpt-35-turbo-16k",
        "gpt-4",
        "gpt-4-32k",
        "gpt-4o",
        "gpt-4o-mini"
      ],
      "metadata": {
        "description": "ATTENTION: USE MODELS THAT YOUR AZURE SUBSCRIPTION IS ALLOWED TO USE.\n\n\nAzure OpenAI Inference Model. https://learn.microsoft.com/en-gb/azure/ai-services/openai/concepts/models\n\nDefault model version will be assigned. The default version is different for different models and might change when there is new version available for a model.\n"
      }
    },
    "InferenceModelDeploymentCapacity": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 1,
      "maxValue": 40,
      "metadata": {
        "description": "Inference deployment model\\'s Tokens-Per-Minute (TPM) capacity, measured in thousands.\nThe default capacity is 30,000 TPM. \nFor model limits specific to your region, refer to the documentation at https://learn.microsoft.com/azure/ai-services/openai/concepts/models#standard-deployment-model-quota.\n"
      }
    },
    "EmbeddingModel": {
      "type": "string",
      "defaultValue": "text-embedding-ada-002",
      "allowedValues": [
        "text-embedding-ada-002",
        "text-embedding-3-small",
        "text-embedding-3-large"
      ],
      "metadata": {
        "description": "ATTENTION: USE MODELS THAT YOUR AZURE SUBSCRIPTION IS ALLOWED TO USE.\n\nAzure OpenAI Embedding Model. https://learn.microsoft.com/azure/ai-services/openai/concepts/models#embeddings\n\nDefault model version will be assigned. The default version is different for different models and might change when there is new version available for a model.\n"
      }
    },
    "EmbeddingModelDeploymentCapacity": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 1,
      "maxValue": 40,
      "metadata": {
        "description": "Embedding deployment model\\'s Tokens-Per-Minute (TPM) capacity, measured in thousands.\nThe default capacity is 30,000 TPM.\nFor model limits specific to your region, refer to the documentation at https://learn.microsoft.com/azure/ai-services/openai/concepts/models#standard-deployment-model-quota.\n"
      }
    },
    "WebServiceAuthorizationKey1": {
      "type": "securestring",
      "minLength": 32,
      "maxLength": 128,
      "metadata": {
        "description": "PLEASE CHOOSE A SECURE AND SECRET KEY ! -\nKernel Memory Service Authorization AccessKey 1.\nThe value is stored as an environment variable and is required by the web service to authenticate HTTP requests.\n"
      }
    },
    "WebServiceAuthorizationKey2": {
      "type": "securestring",
      "minLength": 32,
      "maxLength": 128,
      "metadata": {
        "description": "PLEASE CHOOSE A SECURE AND SECRET KEY ! -\nKernel Memory Service Authorization AccessKey 2.\nThe value is stored as an environment variable and is required by the web service to authenticate HTTP requests.\n"
      }
    },
    "VirtualNetworkAddressSpace": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "Define the address space of your virtual network. Refer to the documentation at https://learn.microsoft.com/azure/virtual-network/concepts-and-best-practices\n"
      }
    },
    "InfrastructureSubnetAddressRange": {
      "type": "string",
      "defaultValue": "10.0.0.0/23",
      "metadata": {
        "description": "Select an address space and configure your subnet for Infrastructure. You can also customize a subnet later. Refer to the documentation at https://learn.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm#subnets\n"
      }
    },
    "ApplicationGatewaySubnetAddressRange": {
      "type": "string",
      "defaultValue": "10.0.2.0/24",
      "metadata": {
        "description": "Select an address space and configure your subnet for Application Gateway. You can also customize a subnet later. Refer to the documentation at https://learn.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm#subnets\n"
      }
    },
    "PrivateEndpointSubnetAddressRange": {
      "type": "string",
      "defaultValue": "10.0.3.0/24",
      "metadata": {
        "description": "Select an address space and configure your subnet for Private Endpoints. You can also customize a subnet later. Refer to the documentation at https://learn.microsoft.com/azure/virtual-network/virtual-network-vnet-plan-design-arm#subnets\n"
      }
    }
  },
  "variables": {
    "rg": "[resourceGroup()]",
    "location": "[resourceGroup().location]",
    "InferenceDeploymentName": "chat",
    "EmbeddingDeploymentName": "embedding",
    "openAiDeployments": [
      {
        "name": "[variables('InferenceDeploymentName')]",
        "model": {
          "format": "OpenAI",
          "name": "[parameters('InferenceModel')]"
        },
        "sku": {
          "name": "Standard",
          "capacity": "[parameters('InferenceModelDeploymentCapacity')]"
        }
      },
      {
        "name": "[variables('EmbeddingDeploymentName')]",
        "model": {
          "format": "OpenAI",
          "name": "[parameters('EmbeddingModel')]"
        },
        "sku": {
          "name": "Standard",
          "capacity": "[parameters('EmbeddingModelDeploymentCapacity')]"
        }
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-vnet-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "vnetName": {
            "value": "[format('km-vnet-{0}', parameters('suffix'))]"
          },
          "VirtualNetworkAddressSpace": {
            "value": "[parameters('VirtualNetworkAddressSpace')]"
          },
          "InfrastructureSubnetAddressRange": {
            "value": "[parameters('InfrastructureSubnetAddressRange')]"
          },
          "ApplicationGatewaySubnetAddressRange": {
            "value": "[parameters('ApplicationGatewaySubnetAddressRange')]"
          },
          "PrivateEndpointSubnetAddressRange": {
            "value": "[parameters('PrivateEndpointSubnetAddressRange')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "14942332175944303797"
            }
          },
          "parameters": {
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the Vnet"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags that will be applied to the VNet"
              }
            },
            "VirtualNetworkAddressSpace": {
              "type": "string"
            },
            "InfrastructureSubnetAddressRange": {
              "type": "string"
            },
            "ApplicationGatewaySubnetAddressRange": {
              "type": "string"
            },
            "PrivateEndpointSubnetAddressRange": {
              "type": "string"
            }
          },
          "variables": {
            "InfrastructureSubnetName": "infrastructure-subnet",
            "ApplicationGatewaySubnetName": "app-gateway-subnet",
            "PrivateEndpointSubnetName": "private-endpoint-subnet"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-11-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('VirtualNetworkAddressSpace')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('InfrastructureSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('InfrastructureSubnetAddressRange')]",
                      "privateEndpointNetworkPolicies": "Enabled",
                      "privateLinkServiceNetworkPolicies": "Disabled"
                    }
                  },
                  {
                    "name": "[variables('ApplicationGatewaySubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('ApplicationGatewaySubnetAddressRange')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Disabled"
                    }
                  },
                  {
                    "name": "[variables('PrivateEndpointSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('PrivateEndpointSubnetAddressRange')]",
                      "privateEndpointNetworkPolicies": "Enabled",
                      "privateLinkServiceNetworkPolicies": "Disabled"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnetName')]"
            },
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "envInfraSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('InfrastructureSubnetName'))]"
            },
            "appGatewaySubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('ApplicationGatewaySubnetName'))]"
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('PrivateEndpointSubnetName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-managedidentity-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "suffix": {
            "value": "[parameters('suffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "18084793981662397801"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "name": {
              "type": "string",
              "defaultValue": "[format('km-UAidentity-{0}', parameters('suffix'))]",
              "minLength": 2,
              "maxLength": 60,
              "metadata": {
                "description": "Managed Identity name."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(format('{0}contributor', resourceGroup().id))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "managedIdentityId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            },
            "managedIdentityClientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-storage-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.vnetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.privateEndpointSubnetId.value]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "5679651508289915330"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "[format('kmstorage{0}', parameters('suffix'))]",
              "metadata": {
                "description": "The name of the Azure Storage Account."
              }
            },
            "storageBlobContainerName": {
              "type": "string",
              "defaultValue": "smemory",
              "metadata": {
                "description": "The name of the Container in Azure Storage."
              }
            },
            "externalTasksQueueName": {
              "type": "string",
              "defaultValue": "[format('km-queue-{0}', parameters('suffix'))]",
              "metadata": {
                "description": "The name of the Queue in Azure Storage."
              }
            },
            "vnetId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "managedIdentityPrincipalId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-09-01",
              "name": "[parameters('storageAccountName')]",
              "tags": "[parameters('tags')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": false,
                "publicNetworkAccess": "Disabled"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('storageBlobContainerName'))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('externalTasksQueueName'))]",
              "properties": {},
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/queueServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(format('Storage Queue Data Contributor-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '974c5e8b-45b9-4653-ba55-5f855dd0fb88')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(format('Storage Blob Data Contributor-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(format('Storage Blob Data Owner-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(format('Storage Queue Data Message Sender-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c6a89b2d-59bc-44d0-9896-0f6e12d7b80a')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(format('Storage Queue Data Message Processor-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8a0f0c08-91a1-4084-bc3d-661d67233fed')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('module_blob_pe_{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "suffix": {
                    "value": "[parameters('suffix')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "serviceName_Used_for_PE": {
                    "value": "[format('{0}-blob', parameters('storageAccountName'))]"
                  },
                  "DNSZoneName": {
                    "value": "[format('privatelink.blob.{0}', environment().suffixes.storage)]"
                  },
                  "vnetId": {
                    "value": "[parameters('vnetId')]"
                  },
                  "privateEndpointSubnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "privateLinkServiceId": {
                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                  },
                  "privateLinkServiceConnections_GroupIds": {
                    "value": [
                      "blob"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "5206819443057151020"
                    }
                  },
                  "parameters": {
                    "suffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(resourceGroup().id)]"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to be assigned to the created resources."
                      }
                    },
                    "serviceName_Used_for_PE": {
                      "type": "string"
                    },
                    "privateEndpointSubnetId": {
                      "type": "string"
                    },
                    "privateLinkServiceId": {
                      "type": "string"
                    },
                    "privateLinkServiceConnections_GroupIds": {
                      "type": "array"
                    },
                    "DNSZoneName": {
                      "type": "string"
                    },
                    "vnetId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('privateEndpointSubnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "private-endpoint-connection",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('privateLinkServiceConnections_GroupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/{1}', format('{0}-pe', parameters('serviceName_Used_for_PE')), format('privateDnsZoneGroup-{0}', parameters('suffix')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('privateDnsZoneGroup-Config-{0}', parameters('suffix'))]",
                            "properties": {
                              "privateDnsZoneId": "[reference(resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))), '2022-09-01').outputs.dnsZoneId.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE')))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('serviceName_Used_for_PE')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "vnetId": {
                            "value": "[parameters('vnetId')]"
                          },
                          "privateDnsZoneName": {
                            "value": "[parameters('DNSZoneName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.29.47.4906",
                              "templateHash": "15260629403946340734"
                            }
                          },
                          "parameters": {
                            "vnetId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "privateDnsZoneName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('privateDnsZoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('privateDnsZoneName'), format('{0}-link', parameters('privateDnsZoneName')))]",
                              "location": "global",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "dnsZoneName": {
                              "type": "string",
                              "value": "[parameters('privateDnsZoneName')]"
                            },
                            "dnsZoneId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('module_queue_pe_{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "suffix": {
                    "value": "[parameters('suffix')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "serviceName_Used_for_PE": {
                    "value": "[format('{0}-queue', parameters('storageAccountName'))]"
                  },
                  "DNSZoneName": {
                    "value": "[format('privatelink.queue.{0}', environment().suffixes.storage)]"
                  },
                  "vnetId": {
                    "value": "[parameters('vnetId')]"
                  },
                  "privateEndpointSubnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "privateLinkServiceId": {
                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                  },
                  "privateLinkServiceConnections_GroupIds": {
                    "value": [
                      "queue"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "5206819443057151020"
                    }
                  },
                  "parameters": {
                    "suffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(resourceGroup().id)]"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to be assigned to the created resources."
                      }
                    },
                    "serviceName_Used_for_PE": {
                      "type": "string"
                    },
                    "privateEndpointSubnetId": {
                      "type": "string"
                    },
                    "privateLinkServiceId": {
                      "type": "string"
                    },
                    "privateLinkServiceConnections_GroupIds": {
                      "type": "array"
                    },
                    "DNSZoneName": {
                      "type": "string"
                    },
                    "vnetId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('privateEndpointSubnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "private-endpoint-connection",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('privateLinkServiceConnections_GroupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/{1}', format('{0}-pe', parameters('serviceName_Used_for_PE')), format('privateDnsZoneGroup-{0}', parameters('suffix')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('privateDnsZoneGroup-Config-{0}', parameters('suffix'))]",
                            "properties": {
                              "privateDnsZoneId": "[reference(resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))), '2022-09-01').outputs.dnsZoneId.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE')))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('serviceName_Used_for_PE')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "vnetId": {
                            "value": "[parameters('vnetId')]"
                          },
                          "privateDnsZoneName": {
                            "value": "[parameters('DNSZoneName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.29.47.4906",
                              "templateHash": "15260629403946340734"
                            }
                          },
                          "parameters": {
                            "vnetId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "privateDnsZoneName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('privateDnsZoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('privateDnsZoneName'), format('{0}-link', parameters('privateDnsZoneName')))]",
                              "location": "global",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "dnsZoneName": {
                              "type": "string",
                              "value": "[parameters('privateDnsZoneName')]"
                            },
                            "dnsZoneId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('module_blob_pe_{0}', parameters('suffix')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The storage account name."
              },
              "value": "[parameters('storageAccountName')]"
            },
            "blobContainerName": {
              "type": "string",
              "metadata": {
                "description": "The storage account name."
              },
              "value": "[parameters('storageBlobContainerName')]"
            },
            "queueName": {
              "type": "string",
              "metadata": {
                "description": "The storage account name."
              },
              "value": "[parameters('externalTasksQueueName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-search-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.vnetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.privateEndpointSubnetId.value]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "5839044347575571066"
            }
          },
          "parameters": {
            "managedIdentityPrincipalId": {
              "type": "string"
            },
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "name": {
              "type": "string",
              "defaultValue": "[format('km-search-{0}', parameters('suffix'))]",
              "minLength": 2,
              "maxLength": 60,
              "metadata": {
                "description": "Service name must only contain lowercase letters, digits or dashes, cannot use dash as the first two or last one characters, cannot contain consecutive dashes, and is limited between 2 and 60 characters in length."
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "standard",
              "allowedValues": [
                "free",
                "basic",
                "standard",
                "standard2",
                "standard3",
                "storage_optimized_l1",
                "storage_optimized_l2"
              ],
              "metadata": {
                "description": "The pricing tier of the search service you want to create (for example, basic or standard)."
              }
            },
            "replicaCount": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "maxValue": 12,
              "metadata": {
                "description": "Replicas distribute search workloads across the service. You need at least two replicas to support high availability of query workloads (not applicable to the free tier)."
              }
            },
            "partitionCount": {
              "type": "int",
              "defaultValue": 1,
              "allowedValues": [
                1,
                2,
                3,
                4,
                6,
                12
              ],
              "metadata": {
                "description": "Partitions allow for scaling of document count as well as faster indexing by sharding your index over multiple search units."
              }
            },
            "hostingMode": {
              "type": "string",
              "defaultValue": "default",
              "allowedValues": [
                "default",
                "highDensity"
              ],
              "metadata": {
                "description": "Applicable only for SKUs set to standard3. You can set this property to enable a single, high density partition that allows up to 1000 indexes, which is much higher than the maximum indexes allowed for any other SKU."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "vnetId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "replicaCount": "[parameters('replicaCount')]",
                "partitionCount": "[parameters('partitionCount')]",
                "hostingMode": "[parameters('hostingMode')]",
                "authOptions": {
                  "aadOrApiKey": {}
                },
                "publicNetworkAccess": "disabled"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('name'))]",
              "name": "[guid(format('Search Index Data Contributor-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('name'))]",
              "name": "[guid(format('Search Service Contributor-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7ca78c08-252a-4471-8644-bb5ff32d4ba0')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('module_search_pe_{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "suffix": {
                    "value": "[parameters('suffix')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "serviceName_Used_for_PE": {
                    "value": "[parameters('name')]"
                  },
                  "DNSZoneName": {
                    "value": "privatelink.search.windows.net"
                  },
                  "vnetId": {
                    "value": "[parameters('vnetId')]"
                  },
                  "privateEndpointSubnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "privateLinkServiceId": {
                    "value": "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
                  },
                  "privateLinkServiceConnections_GroupIds": {
                    "value": [
                      "searchService"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "5206819443057151020"
                    }
                  },
                  "parameters": {
                    "suffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(resourceGroup().id)]"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to be assigned to the created resources."
                      }
                    },
                    "serviceName_Used_for_PE": {
                      "type": "string"
                    },
                    "privateEndpointSubnetId": {
                      "type": "string"
                    },
                    "privateLinkServiceId": {
                      "type": "string"
                    },
                    "privateLinkServiceConnections_GroupIds": {
                      "type": "array"
                    },
                    "DNSZoneName": {
                      "type": "string"
                    },
                    "vnetId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('privateEndpointSubnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "private-endpoint-connection",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('privateLinkServiceConnections_GroupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/{1}', format('{0}-pe', parameters('serviceName_Used_for_PE')), format('privateDnsZoneGroup-{0}', parameters('suffix')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('privateDnsZoneGroup-Config-{0}', parameters('suffix'))]",
                            "properties": {
                              "privateDnsZoneId": "[reference(resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))), '2022-09-01').outputs.dnsZoneId.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE')))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('serviceName_Used_for_PE')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "vnetId": {
                            "value": "[parameters('vnetId')]"
                          },
                          "privateDnsZoneName": {
                            "value": "[parameters('DNSZoneName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.29.47.4906",
                              "templateHash": "15260629403946340734"
                            }
                          },
                          "parameters": {
                            "vnetId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "privateDnsZoneName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('privateDnsZoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('privateDnsZoneName'), format('{0}-link', parameters('privateDnsZoneName')))]",
                              "location": "global",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "dnsZoneName": {
                              "type": "string",
                              "value": "[parameters('privateDnsZoneName')]"
                            },
                            "dnsZoneId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "searchName": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-openai-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.vnetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.privateEndpointSubnetId.value]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
          },
          "name": {
            "value": "[format('km-openai-{0}', parameters('suffix'))]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "sku": {
            "value": {
              "name": "S0"
            }
          },
          "publicNetworkAccess": {
            "value": "Disabled"
          },
          "deployments": {
            "value": "[variables('openAiDeployments')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "74450014706483266"
            },
            "description": "Creates an Azure Cognitive Services instance."
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "customSubDomainName": {
              "type": "string",
              "defaultValue": "[parameters('name')]",
              "metadata": {
                "description": "The custom subdomain name used to access the API. Defaults to the value of the name parameter."
              }
            },
            "deployments": {
              "type": "array",
              "defaultValue": []
            },
            "kind": {
              "type": "string",
              "defaultValue": "OpenAI"
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ]
            },
            "sku": {
              "type": "object",
              "defaultValue": {
                "name": "S0"
              }
            },
            "allowedIpRules": {
              "type": "array",
              "defaultValue": []
            },
            "vnetId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "managedIdentityPrincipalId": {
              "type": "string"
            },
            "networkAcls": {
              "type": "object",
              "defaultValue": "[if(empty(parameters('allowedIpRules')), createObject('defaultAction', 'Allow'), createObject('ipRules', parameters('allowedIpRules'), 'defaultAction', 'Deny'))]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('kind')]",
              "properties": {
                "customSubDomainName": "[parameters('customSubDomainName')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "networkAcls": "[parameters('networkAcls')]",
                "disableLocalAuth": true
              },
              "sku": "[parameters('sku')]"
            },
            {
              "copy": {
                "name": "deployment",
                "count": "[length(parameters('deployments'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), parameters('deployments')[copyIndex()].name)]",
              "properties": {
                "model": "[parameters('deployments')[copyIndex()].model]",
                "raiPolicyName": "[coalesce(tryGet(parameters('deployments')[copyIndex()], 'raiPolicyName'), null())]"
              },
              "sku": "[coalesce(tryGet(parameters('deployments')[copyIndex()], 'sku'), createObject('name', 'Standard', 'capacity', 1))]",
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('name'))]",
              "name": "[guid(format('Cognitive Services OpenAI Contributor-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a001fd3d-188f-4b5d-821b-7da978bf7442')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('name'))]",
              "name": "[guid(format('Cognitive Services OpenAI User-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5e0bd9bd-7b93-4f28-af87-19fc36ad61bd')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('module_openai_pe_{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "suffix": {
                    "value": "[parameters('suffix')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "serviceName_Used_for_PE": {
                    "value": "[parameters('name')]"
                  },
                  "DNSZoneName": {
                    "value": "privatelink.openai.azure.com"
                  },
                  "vnetId": {
                    "value": "[parameters('vnetId')]"
                  },
                  "privateEndpointSubnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "privateLinkServiceId": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
                  },
                  "privateLinkServiceConnections_GroupIds": {
                    "value": [
                      "account"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "5206819443057151020"
                    }
                  },
                  "parameters": {
                    "suffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(resourceGroup().id)]"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to be assigned to the created resources."
                      }
                    },
                    "serviceName_Used_for_PE": {
                      "type": "string"
                    },
                    "privateEndpointSubnetId": {
                      "type": "string"
                    },
                    "privateLinkServiceId": {
                      "type": "string"
                    },
                    "privateLinkServiceConnections_GroupIds": {
                      "type": "array"
                    },
                    "DNSZoneName": {
                      "type": "string"
                    },
                    "vnetId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('privateEndpointSubnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "private-endpoint-connection",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('privateLinkServiceConnections_GroupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/{1}', format('{0}-pe', parameters('serviceName_Used_for_PE')), format('privateDnsZoneGroup-{0}', parameters('suffix')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('privateDnsZoneGroup-Config-{0}', parameters('suffix'))]",
                            "properties": {
                              "privateDnsZoneId": "[reference(resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))), '2022-09-01').outputs.dnsZoneId.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE')))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('serviceName_Used_for_PE')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "vnetId": {
                            "value": "[parameters('vnetId')]"
                          },
                          "privateDnsZoneName": {
                            "value": "[parameters('DNSZoneName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.29.47.4906",
                              "templateHash": "15260629403946340734"
                            }
                          },
                          "parameters": {
                            "vnetId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "privateDnsZoneName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('privateDnsZoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('privateDnsZoneName'), format('{0}-link', parameters('privateDnsZoneName')))]",
                              "location": "global",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "dnsZoneName": {
                              "type": "string",
                              "value": "[parameters('privateDnsZoneName')]"
                            },
                            "dnsZoneId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').endpoint]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-docIntel-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.vnetId.value]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.privateEndpointSubnetId.value]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
          },
          "publicNetworkAccess": {
            "value": "Disabled"
          },
          "name": {
            "value": "[format('km-docIntel-{0}', parameters('suffix'))]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "sku": {
            "value": {
              "name": "S0"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "11877878921179671125"
            },
            "description": "Creates an Azure Document Intelligence (form recognizer) instance."
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "vnetId": {
              "type": "string"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "managedIdentityPrincipalId": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "customSubDomainName": {
              "type": "string",
              "defaultValue": "[parameters('name')]",
              "metadata": {
                "description": "The custom subdomain name used to access the API. Defaults to the value of the name parameter."
              }
            },
            "kind": {
              "type": "string",
              "defaultValue": "FormRecognizer"
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ]
            },
            "sku": {
              "type": "object",
              "defaultValue": {
                "name": "S0"
              }
            },
            "allowedIpRules": {
              "type": "array",
              "defaultValue": []
            },
            "networkAcls": {
              "type": "object",
              "defaultValue": "[if(empty(parameters('allowedIpRules')), createObject('defaultAction', 'Allow'), createObject('ipRules', parameters('allowedIpRules'), 'defaultAction', 'Deny'))]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "[parameters('kind')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "customSubDomainName": "[parameters('customSubDomainName')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "networkAcls": "[parameters('networkAcls')]",
                "disableLocalAuth": true
              },
              "sku": "[parameters('sku')]"
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('name'))]",
              "name": "[guid(format('Cognitive Services User-{0}', parameters('suffix')))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('module_DocIntel_pe{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "suffix": {
                    "value": "[parameters('suffix')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "serviceName_Used_for_PE": {
                    "value": "[parameters('name')]"
                  },
                  "DNSZoneName": {
                    "value": "privatelink.cognitiveservices.azure.com"
                  },
                  "vnetId": {
                    "value": "[parameters('vnetId')]"
                  },
                  "privateEndpointSubnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  },
                  "privateLinkServiceId": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
                  },
                  "privateLinkServiceConnections_GroupIds": {
                    "value": [
                      "account"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "5206819443057151020"
                    }
                  },
                  "parameters": {
                    "suffix": {
                      "type": "string",
                      "defaultValue": "[uniqueString(resourceGroup().id)]"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "tags": {
                      "type": "object",
                      "metadata": {
                        "description": "The tags to be assigned to the created resources."
                      }
                    },
                    "serviceName_Used_for_PE": {
                      "type": "string"
                    },
                    "privateEndpointSubnetId": {
                      "type": "string"
                    },
                    "privateLinkServiceId": {
                      "type": "string"
                    },
                    "privateLinkServiceConnections_GroupIds": {
                      "type": "array"
                    },
                    "DNSZoneName": {
                      "type": "string"
                    },
                    "vnetId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[parameters('privateEndpointSubnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "private-endpoint-connection",
                            "properties": {
                              "privateLinkServiceId": "[parameters('privateLinkServiceId')]",
                              "groupIds": "[parameters('privateLinkServiceConnections_GroupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2024-01-01",
                      "name": "[format('{0}/{1}', format('{0}-pe', parameters('serviceName_Used_for_PE')), format('privateDnsZoneGroup-{0}', parameters('suffix')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('privateDnsZoneGroup-Config-{0}', parameters('suffix'))]",
                            "properties": {
                              "privateDnsZoneId": "[reference(resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))), '2022-09-01').outputs.dnsZoneId.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Resources/deployments', format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE')))]",
                        "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('serviceName_Used_for_PE')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('module-dns-{0}-pe', parameters('serviceName_Used_for_PE'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "vnetId": {
                            "value": "[parameters('vnetId')]"
                          },
                          "privateDnsZoneName": {
                            "value": "[parameters('DNSZoneName')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.29.47.4906",
                              "templateHash": "15260629403946340734"
                            }
                          },
                          "parameters": {
                            "vnetId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "privateDnsZoneName": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('privateDnsZoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('privateDnsZoneName'), format('{0}-link', parameters('privateDnsZoneName')))]",
                              "location": "global",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "dnsZoneName": {
                              "type": "string",
                              "value": "[parameters('privateDnsZoneName')]"
                            },
                            "dnsZoneId": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZoneName'))]"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-insights-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "location": {
            "value": "[variables('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "14091880884769556995"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location where the resources will be created."
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "defaultValue": "[format('km-log-{0}', parameters('suffix'))]",
              "metadata": {
                "description": "The name of the log analytics workspace. If set, it overrides the name generated by the template."
              }
            },
            "applicationInsightsName": {
              "type": "string",
              "defaultValue": "[format('km-appins-{0}', parameters('suffix'))]",
              "metadata": {
                "description": " The name of the application insights. If set, it overrides the name generated by the template."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "features": {
                  "searchVersion": 1
                },
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[parameters('logAnalyticsWorkspaceName')]"
            },
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the application insights."
              },
              "value": "[parameters('applicationInsightsName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-containerAppsEnvironment-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "acaSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.envInfraSubnetId.value]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-insights-{0}', parameters('suffix'))), '2022-09-01').outputs.logAnalyticsWorkspaceName.value]"
          },
          "applicationInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-insights-{0}', parameters('suffix'))), '2022-09-01').outputs.applicationInsightsName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "9308445102453052293"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location where the resources will be created."
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "containerAppsEnvironmentName": {
              "type": "string",
              "defaultValue": "[format('km-cae-{0}', parameters('suffix'))]",
              "metadata": {
                "description": "The name of the container apps environment. If set, it overrides the name generated by the template."
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the log analytics workspace resource create in another module."
              }
            },
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the application insights resource create in another module."
              }
            },
            "acaSubnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet id of the subnet where the container apps environment will be deployed."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2022-10-01",
              "name": "[parameters('containerAppsEnvironmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "daprAIInstrumentationKey": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').InstrumentationKey]",
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2021-06-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2021-06-01').primarySharedKey]"
                  }
                },
                "zoneRedundant": true,
                "vnetConfiguration": {
                  "infrastructureSubnetId": "[parameters('acaSubnetId')]",
                  "internal": true
                }
              }
            }
          ],
          "outputs": {
            "containerAppsEnvironmentName": {
              "type": "string",
              "value": "[parameters('containerAppsEnvironmentName')]"
            },
            "containerAppsEnvironmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName'))]"
            },
            "containerAppsEnvironmentDomain": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName')), '2022-10-01').defaultDomain]"
            },
            "containerAppsEnvironmentStaticIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName')), '2022-10-01').staticIp]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('module-insights-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-containerAppService-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "containerAppsEnvironmentId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-containerAppsEnvironment-{0}', parameters('suffix'))), '2022-09-01').outputs.containerAppsEnvironmentId.value]"
          },
          "applicationInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-insights-{0}', parameters('suffix'))), '2022-09-01').outputs.applicationInsightsName.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix'))), '2022-09-01').outputs.managedIdentityId.value]"
          },
          "managedIdentityClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix'))), '2022-09-01').outputs.managedIdentityClientId.value]"
          },
          "KernelMemoryImageTag": {
            "value": "[parameters('KernelMemoryImageTag')]"
          },
          "KernelMemory__ServiceAuthorization__AccessKey1": {
            "value": "[parameters('WebServiceAuthorizationKey1')]"
          },
          "KernelMemory__ServiceAuthorization__AccessKey2": {
            "value": "[parameters('WebServiceAuthorizationKey2')]"
          },
          "AzureAISearch_Endpoint": {
            "value": "[format('https://{0}.search.windows.net', reference(resourceId('Microsoft.Resources/deployments', format('module-search-{0}', parameters('suffix'))), '2022-09-01').outputs.searchName.value)]"
          },
          "AzureBlobs_Account": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-storage-{0}', parameters('suffix'))), '2022-09-01').outputs.storageAccountName.value]"
          },
          "AzureQueues_Account": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-storage-{0}', parameters('suffix'))), '2022-09-01').outputs.storageAccountName.value]"
          },
          "AzureQueues_QueueName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-storage-{0}', parameters('suffix'))), '2022-09-01').outputs.queueName.value]"
          },
          "AzureOpenAIEmbedding_Deployment": {
            "value": "[variables('EmbeddingDeploymentName')]"
          },
          "AzureOpenAIEmbedding_Endpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-openai-{0}', parameters('suffix'))), '2022-09-01').outputs.endpoint.value]"
          },
          "AzureOpenAIText_Deployment": {
            "value": "[variables('InferenceDeploymentName')]"
          },
          "AzureOpenAIText_Endpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-openai-{0}', parameters('suffix'))), '2022-09-01').outputs.endpoint.value]"
          },
          "AzureAIDocIntel_Endpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-docIntel-{0}', parameters('suffix'))), '2022-09-01').outputs.endpoint.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "11520573448908281320"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags to be assigned to the created resources."
              }
            },
            "managedIdentityId": {
              "type": "string"
            },
            "managedIdentityClientId": {
              "type": "string"
            },
            "KernelMemoryImageTag": {
              "type": "string",
              "defaultValue": "latest"
            },
            "kmServiceName": {
              "type": "string",
              "defaultValue": "[format('km-service-{0}', parameters('suffix'))]"
            },
            "containerAppsEnvironmentId": {
              "type": "string"
            },
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the application insights resource create in another module."
              }
            },
            "AzureBlobs_Account": {
              "type": "string"
            },
            "AzureQueues_Account": {
              "type": "string"
            },
            "AzureQueues_QueueName": {
              "type": "string"
            },
            "AzureAISearch_Endpoint": {
              "type": "string"
            },
            "AzureOpenAIText_Endpoint": {
              "type": "string"
            },
            "AzureOpenAIText_Deployment": {
              "type": "string"
            },
            "AzureOpenAIEmbedding_Endpoint": {
              "type": "string"
            },
            "AzureOpenAIEmbedding_Deployment": {
              "type": "string"
            },
            "AzureAIDocIntel_Endpoint": {
              "type": "string"
            },
            "KernelMemory__ServiceAuthorization__AccessKey1": {
              "type": "string"
            },
            "KernelMemory__ServiceAuthorization__AccessKey2": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2023-05-01",
              "name": "[parameters('kmServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "environmentId": "[parameters('containerAppsEnvironmentId')]",
                "configuration": {
                  "secrets": [
                    {
                      "name": "appinsights-key",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').InstrumentationKey]"
                    }
                  ],
                  "registries": [],
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": true,
                    "transport": "Auto",
                    "allowInsecure": false,
                    "targetPort": 9001,
                    "stickySessions": {
                      "affinity": "none"
                    }
                  }
                },
                "template": {
                  "containers": [
                    {
                      "name": "kernelmemory-service",
                      "image": "[format('docker.io/kernelmemory/service:{0}', parameters('KernelMemoryImageTag'))]",
                      "command": [],
                      "resources": {
                        "cpu": "[json('0.25')]",
                        "memory": "0.5Gi"
                      },
                      "env": [
                        {
                          "name": "ASPNETCORE_ENVIRONMENT",
                          "value": "Production"
                        },
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').ConnectionString]"
                        },
                        {
                          "name": "AZURE_CLIENT_ID",
                          "value": "[parameters('managedIdentityClientId')]"
                        },
                        {
                          "name": "KernelMemory__Service__OpenApiEnabled",
                          "value": "true"
                        },
                        {
                          "name": "KernelMemory__DocumentStorageType",
                          "value": "AzureBlobs"
                        },
                        {
                          "name": "KernelMemory__TextGeneratorType",
                          "value": "AzureOpenAIText"
                        },
                        {
                          "name": "KernelMemory__DefaultIndexName",
                          "value": "default"
                        },
                        {
                          "name": "KernelMemory__ServiceAuthorization__Enabled",
                          "value": "true"
                        },
                        {
                          "name": "KernelMemory__ServiceAuthorization__AuthenticationType",
                          "value": "APIKey"
                        },
                        {
                          "name": "KernelMemory__ServiceAuthorization__HttpHeaderName",
                          "value": "Authorization"
                        },
                        {
                          "name": "KernelMemory__ServiceAuthorization__AccessKey1",
                          "value": "[parameters('KernelMemory__ServiceAuthorization__AccessKey1')]"
                        },
                        {
                          "name": "KernelMemory__ServiceAuthorization__AccessKey2",
                          "value": "[parameters('KernelMemory__ServiceAuthorization__AccessKey2')]"
                        },
                        {
                          "name": "KernelMemory__DataIngestion__DistributedOrchestration__QueueType",
                          "value": "AzureQueues"
                        },
                        {
                          "name": "KernelMemory__DataIngestion__EmbeddingGeneratorTypes__0",
                          "value": "AzureOpenAIEmbedding"
                        },
                        {
                          "name": "KernelMemory__DataIngestion__MemoryDbTypes__0",
                          "value": "AzureAISearch"
                        },
                        {
                          "name": "KernelMemory__DataIngestion__ImageOcrType",
                          "value": "AzureAIDocIntel"
                        },
                        {
                          "name": "KernelMemory__Retrieval__EmbeddingGeneratorType",
                          "value": "AzureOpenAIEmbedding"
                        },
                        {
                          "name": "KernelMemory__Retrieval__MemoryDbType",
                          "value": "AzureAISearch"
                        },
                        {
                          "name": "KernelMemory__Services__AzureBlobs__Account",
                          "value": "[parameters('AzureBlobs_Account')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureQueues__Account",
                          "value": "[parameters('AzureQueues_Account')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureQueues__QueueName",
                          "value": "[parameters('AzureQueues_QueueName')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureAISearch__Endpoint",
                          "value": "[parameters('AzureAISearch_Endpoint')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureOpenAIText__Endpoint",
                          "value": "[parameters('AzureOpenAIText_Endpoint')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureOpenAIText__Deployment",
                          "value": "[parameters('AzureOpenAIText_Deployment')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureOpenAIEmbedding__Endpoint",
                          "value": "[parameters('AzureOpenAIEmbedding_Endpoint')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureOpenAIEmbedding__Deployment",
                          "value": "[parameters('AzureOpenAIEmbedding_Deployment')]"
                        },
                        {
                          "name": "KernelMemory__Services__AzureAIDocIntel__Endpoint",
                          "value": "[parameters('AzureAIDocIntel_Endpoint')]"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 1
                  }
                }
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              }
            }
          ],
          "outputs": {
            "kmServiceName": {
              "type": "string",
              "value": "[parameters('kmServiceName')]"
            },
            "kmServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('kmServiceName'))]"
            },
            "kmServiceAccessKey1": {
              "type": "string",
              "value": "[parameters('KernelMemory__ServiceAuthorization__AccessKey1')]"
            },
            "kmServiceAccessKey2": {
              "type": "string",
              "value": "[parameters('KernelMemory__ServiceAuthorization__AccessKey2')]"
            },
            "kmServiceFQDN": {
              "type": "string",
              "metadata": {
                "description": "The FQDN of the frontend web app service."
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('kmServiceName')), '2023-05-01').configuration.ingress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('module-containerAppsEnvironment-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-docIntel-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-insights-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-managedidentity-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-openai-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-search-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-storage-{0}', parameters('suffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('module-appGateway-{0}', parameters('suffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('location')]"
          },
          "suffix": {
            "value": "[parameters('suffix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "defaultDomain": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-containerAppsEnvironment-{0}', parameters('suffix'))), '2022-09-01').outputs.containerAppsEnvironmentDomain.value]"
          },
          "staticIp": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-containerAppsEnvironment-{0}', parameters('suffix'))), '2022-09-01').outputs.containerAppsEnvironmentStaticIp.value]"
          },
          "vnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.vnetId.value]"
          },
          "containerAppFqdn": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-containerAppService-{0}', parameters('suffix'))), '2022-09-01').outputs.kmServiceFQDN.value]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix'))), '2022-09-01').outputs.appGatewaySubnetId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "14131115677795191231"
            }
          },
          "parameters": {
            "suffix": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().id)]"
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location where the App Gateway will be deployed"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags that will be applied to the App Gateway"
              }
            },
            "staticIp": {
              "type": "string"
            },
            "defaultDomain": {
              "type": "string"
            },
            "vnetId": {
              "type": "string"
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet ID that will be used for the App Gateway configuration"
              }
            },
            "containerAppFqdn": {
              "type": "string",
              "metadata": {
                "description": "The FQDN of the Container App"
              }
            }
          },
          "variables": {
            "appGatewayName": "[format('km-appG-{0}', parameters('suffix'))]",
            "ipAddressName": "[format('km-appG-pip-{0}', parameters('suffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[parameters('defaultDomain')]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/A",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultDomain'), '*')]",
              "properties": {
                "ttl": 3600,
                "aRecords": [
                  {
                    "ipv4Address": "[parameters('staticIp')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultDomain'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/A",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultDomain'), '@')]",
              "properties": {
                "ttl": 3600,
                "aRecords": [
                  {
                    "ipv4Address": "[parameters('staticIp')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultDomain'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultDomain'), 'pdns-link')]",
              "tags": "[parameters('tags')]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultDomain'))]"
              ]
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "[variables('ipAddressName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "zones": [
                "1"
              ],
              "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2023-11-01",
              "name": "[variables('appGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "zones": [
                "1"
              ],
              "properties": {
                "sku": {
                  "tier": "Standard_v2",
                  "capacity": 1,
                  "name": "Standard_v2"
                },
                "gatewayIPConfigurations": [
                  {
                    "name": "appgateway-subnet",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      }
                    }
                  }
                ],
                "frontendIPConfigurations": [
                  {
                    "name": "my-frontend",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('ipAddressName'))]"
                      }
                    }
                  }
                ],
                "frontendPorts": [
                  {
                    "name": "port_80",
                    "properties": {
                      "port": 80
                    }
                  }
                ],
                "backendAddressPools": [
                  {
                    "name": "my-agw-backend-pool",
                    "properties": {
                      "backendAddresses": [
                        {
                          "fqdn": "[parameters('containerAppFqdn')]"
                        }
                      ]
                    }
                  }
                ],
                "probes": [
                  {
                    "name": "health-http",
                    "properties": {
                      "protocol": "Http",
                      "path": "/health",
                      "interval": 30,
                      "timeout": 30,
                      "unhealthyThreshold": 3,
                      "pickHostNameFromBackendHttpSettings": true,
                      "minServers": 0,
                      "match": {}
                    }
                  },
                  {
                    "name": "health-https",
                    "properties": {
                      "protocol": "Https",
                      "path": "/health",
                      "interval": 30,
                      "timeout": 30,
                      "unhealthyThreshold": 3,
                      "pickHostNameFromBackendHttpSettings": true,
                      "minServers": 0,
                      "match": {}
                    }
                  }
                ],
                "backendHttpSettingsCollection": [
                  {
                    "name": "backend-setting-https",
                    "properties": {
                      "protocol": "Https",
                      "port": 443,
                      "cookieBasedAffinity": "Disabled",
                      "requestTimeout": 20,
                      "pickHostNameFromBackendAddress": true,
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/probes', variables('appGatewayName'), 'health-https')]"
                      }
                    }
                  },
                  {
                    "name": "backend-setting-http",
                    "properties": {
                      "protocol": "Http",
                      "port": 80,
                      "cookieBasedAffinity": "Disabled",
                      "requestTimeout": 20,
                      "pickHostNameFromBackendAddress": true,
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/probes', variables('appGatewayName'), 'health-http')]"
                      }
                    }
                  }
                ],
                "httpListeners": [
                  {
                    "name": "my-agw-listener",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', variables('appGatewayName'), 'my-frontend')]"
                      },
                      "frontendPort": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', variables('appGatewayName'), 'port_80')]"
                      },
                      "protocol": "Http"
                    }
                  }
                ],
                "requestRoutingRules": [
                  {
                    "name": "my-agw-routing-rule",
                    "properties": {
                      "priority": 1,
                      "ruleType": "Basic",
                      "httpListener": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', variables('appGatewayName'), 'my-agw-listener')]"
                      },
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', variables('appGatewayName'), 'my-agw-backend-pool')]"
                      },
                      "backendHttpSettings": {
                        "id": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', variables('appGatewayName'), 'backend-setting-https')]"
                      }
                    }
                  }
                ],
                "enableHttp2": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('ipAddressName'))]"
              ]
            }
          ],
          "outputs": {
            "ipAddress": {
              "type": "string",
              "metadata": {
                "description": "Public IP"
              },
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('ipAddressName')), '2023-11-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('module-containerAppService-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-containerAppsEnvironment-{0}', parameters('suffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('module-vnet-{0}', parameters('suffix')))]"
      ]
    }
  ],
  "outputs": {
    "kmServiceEndpoint": {
      "type": "string",
      "metadata": {
        "description": "The public IP of the Kernel Memory service."
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-appGateway-{0}', parameters('suffix'))), '2022-09-01').outputs.ipAddress.value]"
    },
    "kmServiceAccessKey1": {
      "type": "string",
      "metadata": {
        "description": "Service Access Key 1."
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-containerAppService-{0}', parameters('suffix'))), '2022-09-01').outputs.kmServiceAccessKey1.value]"
    },
    "kmServiceAccessKey2": {
      "type": "string",
      "metadata": {
        "description": "Service Access Key 2."
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('module-containerAppService-{0}', parameters('suffix'))), '2022-09-01').outputs.kmServiceAccessKey2.value]"
    }
  }
}